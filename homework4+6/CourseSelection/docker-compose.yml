services:
  # 数据库服务（对应任务二的 mysql 服务）
  db:
    image: mysql:8.4  # 注意 image 后加空格
    container_name: todo-mysql
    restart: unless-stopped  # unless-stopped 前加空格
    environment:
      MYSQL_ROOT_PASSWORD: 123456  # 密码值前加空格
      MYSQL_DATABASE: course_select
      MYSQL_USER: todo
      MYSQL_PASSWORD: todo_pass
      TZ: Asia/Shanghai  # 时区值前加空格
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci  # 补全空格和短横线
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql  # 卷名保持一致
      # 若有初始化 SQL，确保路径正确（可选，没有可删除此行）
      - ./src/main/resources/db/init.sql:/docker-entrypoint-initdb.d/1-init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -u root -p$${MYSQL_ROOT_PASSWORD} --silent"]
      interval: 5s
      timeout: 3s  # 缩进对齐（与 interval 同级）
      retries: 30

  # 应用服务（对应任务二的 app 服务）
  app:  # 修正关键字拼写（原 app： 有中文冒号）
    build:
      context: .  # 构建上下文为当前目录（必填）
      dockerfile: Dockerfile
    container_name: todo-app
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy  # 依赖数据库健康检查通过
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://db:3306/course_select?useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: 123456 
      SPRING_PROFILES_ACTIVE: docker
      SPRING_JPA_HIBERNATE_DDL_AUTO: update 
      SPRING_JPA_SHOW_SQL: "true"
      DB_URL: jdbc:mysql://db:3306/todo_db?useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true
      DB_USERNAME: todo
      DB_PASSWORD: todo_pass
      TZ: Asia/Shanghai
    ports:
      - "8080:8080"

# 数据卷配置（与 services 同级）
volumes:
  mysql-data:
    driver: local

